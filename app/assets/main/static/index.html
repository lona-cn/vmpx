<!DOCTYPE html>
<html lang="zh-CN" x-data="vmpxApp()" x-init="init()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VMPX æ§åˆ¶å°</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4f46e5;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --danger-color: #ef4444;
      --dark-color: #1f2937;
      --light-color: #f3f4f6;
    }
    
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background-color: #f9fafb;
      color: #374151;
    }
    
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .btn {
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: #4338ca;
      border-color: #4338ca;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-success:hover {
      background-color: #059669;
      border-color: #059669;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .btn-warning:hover {
      background-color: #d97706;
      border-color: #d97706;
      transform: translateY(-1px);
    }
    
    .btn-outline-secondary:hover {
      background-color: var(--light-color);
      transform: translateY(-1px);
    }
    
    .btn-outline-primary {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-1px);
    }
    
    .btn-outline-dark {
      border-color: var(--dark-color);
      color: var(--dark-color);
    }
    
    .btn-outline-dark:hover {
      background-color: var(--dark-color);
      color: white;
      transform: translateY(-1px);
    }
    
    .input-group-text {
      background-color: var(--light-color);
      border-color: #e5e7eb;
    }
    
    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
    }
    
    textarea {
      font-family: 'Monaco', 'Consolas', monospace;
    }
    
    pre {
      font-family: 'Monaco', 'Consolas', monospace;
      background-color: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 0.375rem;
      padding: 1rem;
      overflow-x: auto;
      font-size: 0.875rem;
    }
    
    .list-group-item {
      transition: background-color 0.2s ease;
    }
    
    .list-group-item:hover {
      background-color: #f9fafb;
    }
    
    .toast {
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .header-gradient {
      background: linear-gradient(135deg, var(--primary-color), #7c3aed);
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <header class="header-gradient text-white py-4 shadow-lg">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center">
        <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold flex items-center">
          <span class="text-2xl mr-2">ğŸ›ï¸</span>
          VMPX æ§åˆ¶å°
        </h1>
        <button 
          class="bg-white bg-opacity-20 hover:bg-opacity-30 transition-all px-4 py-2 rounded-lg flex items-center"
          @click="init()"
        >
          <span class="mr-2">ğŸ”„</span>
          åˆ·æ–°åº”ç”¨åˆ—è¡¨
        </button>
      </div>
    </div>
  </header>

  <!-- ä¸»è¦å†…å®¹ -->
  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- å·¦ï¼šApp åˆ—è¡¨ -->
      <div class="card bg-white rounded-xl shadow-md p-5">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <span class="text-lg mr-2">ğŸ“¦</span>
            App åˆ—è¡¨
          </h2>
          <button 
            class="btn btn-sm btn-outline-secondary rounded-full px-4"
            @click="init()"
          >
            <span class="mr-1">ğŸ”„</span>
            åˆ·æ–°
          </button>
        </div>
        <div class="overflow-y-auto max-h-[400px] pr-1">
          <ul class="rounded-lg overflow-hidden border">
            <template x-for="name in apps" :key="name">
              <li class="border-b last:border-b-0">
                <div class="p-3 flex justify-between items-center bg-white">
                  <span class="font-medium text-gray-700" x-text="name"></span>
                  <div class="btn-group">
                    <button 
                      class="btn btn-sm btn-outline-primary rounded-l-md px-3"
                      @click="loadProductInfo(name)"
                      x-tooltip="åŠ è½½äº§å“ä¿¡æ¯"
                    >
                      åŠ è½½
                    </button>
                    <button 
                      class="btn btn-sm btn-outline-dark rounded-r-md px-3"
                      @click="packApp(name)"
                      x-tooltip="åŠ å£³åº”ç”¨"
                    >
                      åŠ å£³
                    </button>
                  </div>
                </div>
              </li>
            </template>
          </ul>
          <div class="mt-2 text-center text-gray-500 text-sm" x-show="apps.length === 0">
            æš‚æ— åº”ç”¨ï¼Œè¯·ä¸Šä¼ æ–°åº”ç”¨
          </div>
        </div>
      </div>

      <!-- ä¸­ï¼šProductInfo -->
      <div class="card bg-white rounded-xl shadow-md p-5">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <span class="text-lg mr-2">ğŸ§¬</span>
          ProductInfo
        </h2>
        <textarea 
          class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 mb-3"
          rows="12" 
          x-model="productInfoText" 
          spellcheck="false" 
          placeholder="ç‚¹å‡» App åˆ—è¡¨é¡¹åŠ è½½æˆ–æ‰‹åŠ¨ç²˜è´´..."
        ></textarea>
        <div class="flex flex-col sm:flex-row justify-between gap-3">
          <div class="input-group flex-1 max-w-xs">
            <span class="input-group-text bg-gray-100">Key Size</span>
            <input 
              type="number" 
              class="form-control" 
              x-model.number="keySize" 
              min="1024" 
              step="1024"
            />
          </div>
          <button 
            class="btn btn-primary rounded-lg px-6 py-2 font-medium flex items-center justify-center"
            @click="generateRandomProductInfo()"
          >
            <span class="mr-2">ğŸ²</span>
            éšæœºç”Ÿæˆ
          </button>
        </div>
      </div>

      <!-- å³ï¼šåºåˆ—å· -->
      <div class="card bg-white rounded-xl shadow-md p-5">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
          <span class="text-lg mr-2">ğŸ”</span>
          ç”Ÿæˆåºåˆ—å·
        </h2>
        <form @submit.prevent="generateSerial()" class="space-y-3">
          <input 
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            placeholder="ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰" 
            x-model="serial.user_name" 
          />
          <input 
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰" 
            x-model="serial.email" 
            type="email"
          />
          <input 
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            placeholder="ç¡¬ä»¶IDï¼ˆå¯é€‰ï¼‰" 
            x-model="serial.hwid" 
          />
          <input 
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            type="date" 
            x-model="serial.exp_date" 
            required 
          />
          <div class="form-check">
            <input 
              class="form-check-input rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
              type="checkbox" 
              x-model="ignoreAdapters" 
              id="ignoreAdapters" 
            />
            <label class="form-check-label text-gray-700" for="ignoreAdapters">
              å¿½ç•¥ç½‘å¡
            </label>
          </div>
          <button 
            class="btn btn-success w-100 py-2 font-medium rounded-lg"
            type="submit"
          >
            <span class="mr-2">âœ¨</span>
            ç”Ÿæˆåºåˆ—å·
          </button>
        </form>
        <div class="mt-4">
          <pre 
            class="p-3 border rounded-lg bg-gray-50 text-sm text-gray-700 max-h-[200px] overflow-auto"
            x-text="serialOutput"
            x-show="serialOutput"
          ></pre>
          <button 
            class="btn btn-outline-secondary rounded-lg px-4 py-1 mt-2 transition-all"
            @click="copySerial()" 
            x-show="serialOutput"
          >
            <span class="mr-1">ğŸ“‹</span>
            å¤åˆ¶åºåˆ—å·
          </button>
        </div>
      </div>
    </div>

    <!-- App ä¸Šä¼  -->
    <div class="mt-8 card bg-white rounded-xl shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-5 flex items-center">
        <span class="text-lg mr-2">ğŸ“¤</span>
        ä¸Šä¼ æ–° App
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="mb-3">
          <label for="appFile" class="block text-sm font-medium text-gray-700 mb-1">
            é€‰æ‹©æ–‡ä»¶
          </label>
          <div class="relative">
            <input 
              type="file" 
              id="appFile"
              class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
              x-ref="appFile" 
            />
          </div>
        </div>
        <div class="mb-3">
          <label for="newAppName" class="block text-sm font-medium text-gray-700 mb-1">
            App åç§° <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="newAppName"
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            placeholder="App åç§°ï¼ˆå¿…å¡«ï¼‰" 
            x-model="newAppName" 
          />
        </div>
        <div class="mb-3">
          <label for="newAppPath" class="block text-sm font-medium text-gray-700 mb-1">
            App æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰
          </label>
          <input 
            type="text" 
            id="newAppPath"
            class="form-control rounded-lg border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
            placeholder="App æ–‡ä»¶è·¯å¾„ï¼ˆå¯é€‰ï¼‰" 
            x-model="newAppPath" 
          />
        </div>
      </div>
      <button 
        class="btn btn-warning mt-4 px-6 py-2 font-medium rounded-lg flex items-center"
        @click="uploadApp()"
      >
        <span class="mr-2">ğŸš€</span>
        ä¸Šä¼ åº”ç”¨
      </button>
    </div>
  </main>
  
  <!-- é¡µè„š -->
  <footer class="bg-gray-100 border-t border-gray-200 mt-12 py-6">
    <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
      <p>VMPX æ§åˆ¶å° &copy; 2023</p>
    </div>
  </footer>

  <!-- Toast æç¤ºåŒºåŸŸ -->
  <div 
    class="fixed bottom-4 right-4 z-50 transition-all duration-300 transform translate-x-full opacity-0" 
    id="toastBox"
    x-ref="toastBox"
  >
    <div class="bg-success text-white rounded-lg shadow-lg p-4 max-w-xs">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium" id="toastMessage">æ“ä½œæˆåŠŸ</p>
        </div>
        <button 
          type="button" 
          class="ml-auto flex-shrink-0 inline-flex items-center justify-center rounded-md text-white hover:text-gray-200 focus:outline-none"
          onclick="document.getElementById('toastBox').classList.add('translate-x-full', 'opacity-0')"
        >
          <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    function getFileNameFromDispositionOld(header) {
      if (!header) return null;
      const match = decodeURIComponent(header).match(/filename\*?=(?:UTF-8'')?([^;]+)/i);
      if (match && match[1]) {
        try {
          //return decodeURIComponent(match[1].replace(/["']/g, ''));
          return match1[1]
        } catch (e) {
          return match[1];
        }
      }
      return null;
    }
    function getFileNameFromDisposition(header) {
      if (!header) return null;

      const str = decodeURIComponent(header);
      const prefix = "filename*=UTF-8''";
      const start = str.indexOf(prefix);
      if (start === -1) return null;

      // ä» prefix åé¢å¼€å§‹æˆªå–
      let rest = str.substring(start + prefix.length);

      // æˆªå–åˆ°åˆ†å·æˆ–ç»“å°¾
      const end = rest.indexOf(';');
      if (end !== -1) {
        rest = rest.substring(0, end);
      }

      // å»é™¤å¯èƒ½çš„å¼•å·å’Œç©ºç™½
      //return rest.trim().replace(/^["']|["']$/g, '');
      return rest;
    }

    function vmpxApp() {
      return {
        apps: [],
        keySize: 2048,
        productInfoText: '',
        serial: {
          user_name: '',
          email: '',
          hwid: '',
          exp_date: ''
        },
        ignoreAdapters: false,
        serialOutput: '',
        newAppName: '',
        newAppPath: '',

        async init() {
          try {
            const res = await fetch('/api/v1/app/list');
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            this.apps = await res.json();
            this.showToast('åº”ç”¨åˆ—è¡¨å·²æ›´æ–°', 'success');
          } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            this.showToast('åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥', 'danger');
          }
        },

        async generateRandomProductInfo() {
          try {
            const res = await fetch('/api/v1/gen_random_product_info', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ key_size: this.keySize })
            });
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.productInfoText = JSON.stringify(data, null, 2);
            this.showToast('å·²ç”Ÿæˆéšæœº ProductInfo', 'success');
          } catch (error) {
            console.error('ç”Ÿæˆå¤±è´¥:', error);
            this.showToast('ç”Ÿæˆ ProductInfo å¤±è´¥', 'danger');
          }
        },

        async loadProductInfo(name) {
          try {
            const res = await fetch(`/api/v1/app/product_info?name=${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.productInfoText = JSON.stringify(data, null, 2);
            this.showToast(`å·²åŠ è½½ ${name} çš„ ProductInfo`, 'success');
          } catch (error) {
            console.error('åŠ è½½å¤±è´¥:', error);
            this.showToast('åŠ è½½ ProductInfo å¤±è´¥', 'danger');
          }
        },

        async generateSerial() {
          let parsed;
          try {
            parsed = JSON.parse(this.productInfoText);
          } catch (e) {
            this.showToast('ProductInfo JSON æ— æ•ˆï¼', 'danger');
            return;
          }

          if (!this.serial.exp_date) {
            this.showToast('è¯·é€‰æ‹©è¿‡æœŸæ—¥æœŸ', 'warning');
            return;
          }

          const [year, month, day] = this.serial.exp_date.split('-').map(Number);
          const payload = {
            product_info: parsed,
            serial_info: {
              user_name: this.serial.user_name || "",
              email: this.serial.email || "",
              hwid: this.serial.hwid || "",
              exp_year: year,
              exp_month: month,
              exp_day: day
            },
            ignore_network_adapters: this.ignoreAdapters
          };

          try {
            const res = await fetch('/api/v1/gen_serial_number', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.serialOutput = JSON.stringify(data, null, 2);
            this.showToast('åºåˆ—å·ç”ŸæˆæˆåŠŸ', 'success');
          } catch (error) {
            console.error('ç”Ÿæˆåºåˆ—å·å¤±è´¥:', error);
            this.showToast('ç”Ÿæˆåºåˆ—å·å¤±è´¥', 'danger');
          }
        },

        async packApp(name) {
          try {
            const res = await fetch(`/api/v1/app/pack?name=${encodeURIComponent(name)}`, {
              method: 'POST',
            });
            // ç¡®ä¿è¿”å›æˆåŠŸ
            if (!res.ok) throw new Error('ä¸‹è½½å¤±è´¥');
            // æå–æ–‡ä»¶åï¼ˆä» Content-Dispositionï¼‰
            const disposition = res.headers.get('Content-Disposition');
            const filename = getFileNameFromDisposition(disposition) || `${name}.zip`;
            // è·å– Blob æ•°æ®
            const blob = await res.blob();
            // åˆ›å»º URL å¹¶è§¦å‘ä¸‹è½½
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            this.showToast(`åº”ç”¨ ${name} åŠ å£³æˆåŠŸï¼Œå¼€å§‹ä¸‹è½½`, 'success');
          } catch (error) {
            console.error('åŠ å£³å¤±è´¥:', error);
            this.showToast('åº”ç”¨åŠ å£³å¤±è´¥', 'danger');
          }
        },

        async uploadApp() {
          const file = this.$refs.appFile.files[0];
          if (!file || !this.newAppName.trim()) {
            this.showToast('è¯·å¡«å†™ App åç§°å¹¶é€‰æ‹©æ–‡ä»¶', 'warning');
            return;
          }

          let url = `/api/v1/app/add?name=${encodeURIComponent(this.newAppName.trim())}`;
          if (this.newAppPath.trim()) {
            url += `&vmp_file_path=${encodeURIComponent(this.newAppPath.trim())}`;
          }

          try {
            const res = await fetch(url, {
              method: 'POST',
              body: file
            });

            if (res.ok) {
              this.showToast(`åº”ç”¨ ${this.newAppName} ä¸Šä¼ æˆåŠŸ`, 'success');
              this.init();
              this.newAppName = '';
              this.newAppPath = '';
              this.$refs.appFile.value = '';
            } else {
              throw new Error('ä¸Šä¼ å¤±è´¥');
            }
          } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            this.showToast('åº”ç”¨ä¸Šä¼ å¤±è´¥', 'danger');
          }
        },
        copySerial() {
          try {
            const parsed = JSON.parse(this.serialOutput);
            const serial = parsed.serial_number || '';
            if (!serial) {
              this.showToast('âš ï¸ æœªæ‰¾åˆ° serial_number å­—æ®µ', 'warning');
              return;
            }
            navigator.clipboard.writeText(serial).then(() => {
              this.showToast('âœ… å·²å¤åˆ¶åºåˆ—å·', 'success');
            }).catch(() => {
              this.showToast('âš ï¸ æ— æ³•è®¿é—®å‰ªè´´æ¿', 'danger');
            });
          } catch (e) {
            this.showToast('âš ï¸ è¾“å‡ºæ ¼å¼æ— æ•ˆ', 'warning');
          }
        },
        showToast(message, type = 'success') {
          const toastEl = document.getElementById('toastBox');
          const toastMsg = document.getElementById('toastMessage');
          const icon = toastEl.querySelector('svg');
          const container = toastEl.querySelector('div');
          
          // è®¾ç½®æ¶ˆæ¯å†…å®¹
          toastMsg.textContent = message;
          
          // è®¾ç½®ç±»å‹æ ·å¼
          container.className = '';
          if (type === 'success') {
            container.className = 'bg-success text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />';
          } else if (type === 'danger') {
            container.className = 'bg-danger text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />';
          } else if (type === 'warning') {
            container.className = 'bg-warning text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />';
          }
          
          // æ˜¾ç¤ºtoast
          toastEl.classList.remove('translate-x-full', 'opacity-0');
          
          // 3ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            toastEl.classList.add('translate-x-full', 'opacity-0');
          }, 3000);
        }
      }
    }
  </script>
</body>
</html>

  <script>
    function getFileNameFromDispositionOld(header) {
      if (!header) return null;
      const match = decodeURIComponent(header).match(/filename\*?=(?:UTF-8'')?([^;]+)/i);
      if (match && match[1]) {
        try {
          //return decodeURIComponent(match[1].replace(/["']/g, ''));
          return match1[1]
        } catch (e) {
          return match[1];
        }
      }
      return null;
    }
    function getFileNameFromDisposition(header) {
      if (!header) return null;

      const str = decodeURIComponent(header);
      const prefix = "filename*=UTF-8''";
      const start = str.indexOf(prefix);
      if (start === -1) return null;

      // ä» prefix åé¢å¼€å§‹æˆªå–
      let rest = str.substring(start + prefix.length);

      // æˆªå–åˆ°åˆ†å·æˆ–ç»“å°¾
      const end = rest.indexOf(';');
      if (end !== -1) {
        rest = rest.substring(0, end);
      }

      // å»é™¤å¯èƒ½çš„å¼•å·å’Œç©ºç™½
      //return rest.trim().replace(/^["']|["']$/g, '');
      return rest;
    }

    function vmpxApp() {
      return {
        apps: [],
        keySize: 2048,
        productInfoText: '',
        serial: {
          user_name: '',
          email: '',
          hwid: '',
          exp_date: ''
        },
        ignoreAdapters: false,
        serialOutput: '',
        newAppName: '',
        newAppPath: '',

        async init() {
          try {
            const res = await fetch('/api/v1/app/list');
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            this.apps = await res.json();
            this.showToast('åº”ç”¨åˆ—è¡¨å·²æ›´æ–°', 'success');
          } catch (error) {
            console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            this.showToast('åŠ è½½åº”ç”¨åˆ—è¡¨å¤±è´¥', 'danger');
          }
        },

        async generateRandomProductInfo() {
          try {
            const res = await fetch('/api/v1/gen_random_product_info', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ key_size: this.keySize })
            });
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.productInfoText = JSON.stringify(data, null, 2);
            this.showToast('å·²ç”Ÿæˆéšæœº ProductInfo', 'success');
          } catch (error) {
            console.error('ç”Ÿæˆå¤±è´¥:', error);
            this.showToast('ç”Ÿæˆ ProductInfo å¤±è´¥', 'danger');
          }
        },

        async loadProductInfo(name) {
          try {
            const res = await fetch(`/api/v1/app/product_info?name=${encodeURIComponent(name)}`);
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.productInfoText = JSON.stringify(data, null, 2);
            this.showToast(`å·²åŠ è½½ ${name} çš„ ProductInfo`, 'success');
          } catch (error) {
            console.error('åŠ è½½å¤±è´¥:', error);
            this.showToast('åŠ è½½ ProductInfo å¤±è´¥', 'danger');
          }
        },

        async generateSerial() {
          let parsed;
          try {
            parsed = JSON.parse(this.productInfoText);
          } catch (e) {
            this.showToast('ProductInfo JSON æ— æ•ˆï¼', 'danger');
            return;
          }

          if (!this.serial.exp_date) {
            this.showToast('è¯·é€‰æ‹©è¿‡æœŸæ—¥æœŸ', 'warning');
            return;
          }

          const [year, month, day] = this.serial.exp_date.split('-').map(Number);
          const payload = {
            product_info: parsed,
            serial_info: {
              user_name: this.serial.user_name || "",
              email: this.serial.email || "",
              hwid: this.serial.hwid || "",
              exp_year: year,
              exp_month: month,
              exp_day: day
            },
            ignore_network_adapters: this.ignoreAdapters
          };

          try {
            const res = await fetch('/api/v1/gen_serial_number', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            const data = await res.json();
            this.serialOutput = JSON.stringify(data, null, 2);
            this.showToast('åºåˆ—å·ç”ŸæˆæˆåŠŸ', 'success');
          } catch (error) {
            console.error('ç”Ÿæˆåºåˆ—å·å¤±è´¥:', error);
            this.showToast('ç”Ÿæˆåºåˆ—å·å¤±è´¥', 'danger');
          }
        },

        async packApp(name) {
          try {
            const res = await fetch(`/api/v1/app/pack?name=${encodeURIComponent(name)}`, {
              method: 'POST',
            });
            // ç¡®ä¿è¿”å›æˆåŠŸ
            if (!res.ok) throw new Error('ä¸‹è½½å¤±è´¥');
            // æå–æ–‡ä»¶åï¼ˆä» Content-Dispositionï¼‰
            const disposition = res.headers.get('Content-Disposition');
            const filename = getFileNameFromDisposition(disposition) || `${name}.zip`;
            // è·å– Blob æ•°æ®
            const blob = await res.blob();
            // åˆ›å»º URL å¹¶è§¦å‘ä¸‹è½½
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            this.showToast(`åº”ç”¨ ${name} åŠ å£³æˆåŠŸï¼Œå¼€å§‹ä¸‹è½½`, 'success');
          } catch (error) {
            console.error('åŠ å£³å¤±è´¥:', error);
            this.showToast('åº”ç”¨åŠ å£³å¤±è´¥', 'danger');
          }
        },

        async uploadApp() {
          const file = this.$refs.appFile.files[0];
          if (!file || !this.newAppName.trim()) {
            this.showToast('è¯·å¡«å†™ App åç§°å¹¶é€‰æ‹©æ–‡ä»¶', 'warning');
            return;
          }

          let url = `/api/v1/app/add?name=${encodeURIComponent(this.newAppName.trim())}`;
          if (this.newAppPath.trim()) {
            url += `&vmp_file_path=${encodeURIComponent(this.newAppPath.trim())}`;
          }

          try {
            const res = await fetch(url, {
              method: 'POST',
              body: file
            });

            if (res.ok) {
              this.showToast(`åº”ç”¨ ${this.newAppName} ä¸Šä¼ æˆåŠŸ`, 'success');
              this.init();
              this.newAppName = '';
              this.newAppPath = '';
              this.$refs.appFile.value = '';
            } else {
              throw new Error('ä¸Šä¼ å¤±è´¥');
            }
          } catch (error) {
            console.error('ä¸Šä¼ å¤±è´¥:', error);
            this.showToast('åº”ç”¨ä¸Šä¼ å¤±è´¥', 'danger');
          }
        },
        copySerial() {
          try {
            const parsed = JSON.parse(this.serialOutput);
            const serial = parsed.serial_number || '';
            if (!serial) {
              this.showToast('âš ï¸ æœªæ‰¾åˆ° serial_number å­—æ®µ', 'warning');
              return;
            }
            navigator.clipboard.writeText(serial).then(() => {
              this.showToast('âœ… å·²å¤åˆ¶åºåˆ—å·', 'success');
            }).catch(() => {
              this.showToast('âš ï¸ æ— æ³•è®¿é—®å‰ªè´´æ¿', 'danger');
            });
          } catch (e) {
            this.showToast('âš ï¸ è¾“å‡ºæ ¼å¼æ— æ•ˆ', 'warning');
          }
        },
        showToast(message, type = 'success') {
          const toastEl = document.getElementById('toastBox');
          const toastMsg = document.getElementById('toastMessage');
          const icon = toastEl.querySelector('svg');
          const container = toastEl.querySelector('div');
          
          // è®¾ç½®æ¶ˆæ¯å†…å®¹
          toastMsg.textContent = message;
          
          // è®¾ç½®ç±»å‹æ ·å¼
          container.className = '';
          if (type === 'success') {
            container.className = 'bg-success text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />';
          } else if (type === 'danger') {
            container.className = 'bg-danger text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />';
          } else if (type === 'warning') {
            container.className = 'bg-warning text-white rounded-lg shadow-lg p-4 max-w-xs';
            icon.innerHTML = '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />';
          }
          
          // æ˜¾ç¤ºtoast
          toastEl.classList.remove('translate-x-full', 'opacity-0');
          
          // 3ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            toastEl.classList.add('translate-x-full', 'opacity-0');
          }, 3000);
        }
      }
    }
  </script>
</body>
</html>
